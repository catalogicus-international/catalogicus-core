const a6_0x1aa3=['value','../../error/print-run-group-error','completed','NO_MESSAGES_TIMEOUT','Fetching\x20tasks...','strip-json-comments','retryDuring','maxParallel:\x20','printCacheableTargetsError','includes','target','join','status','find','VERBOSE_LOGGING','executionId','RUN_GROUP_COMPLETED','reset','map','CIRCLE_JOB','No\x20new\x20messages\x20received\x20after\x20','../../../utilities/create-unchanged-value-timeout','length','NO_FURTHER_TASKS_TO_RUN','/lockfiles','CIRCLE_STAGE','../../../utilities/environment','printInvalidRunnerError','inherit','__esModule','number\x20of\x20tasks:\x20','options','Critical\x20Error\x20in\x20Agent:\x20\x22','End\x20all\x20currently\x20running\x20agents,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22,\x20and\x20try\x20again.','Error:','message','note','writeFileSync','API\x20Response','params','tasksRunnerOptions','__awaiter','retryDuring:\x20','forEach','mkdirSync','toString','configuration','then','split','startAgent','../../error/print-invalid-runner-error','getRunGroup','warn','npx\x20nx\x20run-many\x20--target=','tasks','getTime','readFileSync','@nrwl/nx-cloud','getNxCacheDirectory','completeRunGroupWithError','\x20--projects=','SIGTERM','trim','CIRCLECI','Waiter','execSync','taskId','runner','push','ignore','parse','DistributedAgentApi','submitRunMetrics','done','true','Duplicate\x20Agent\x20ID\x20Detected','catch','maxParallel','apply','Command\x20execution\x20failed\x20(distributed\x20task\x20execution:\x20','defineProperty','floor',').\x20Tasks\x20hashes\x20haven\x27t\x20been\x20recorded.','exit','Agent\x20','error:\x20','assign','executionId:\x20','existsSync','throw','argv','SIGINT','completedTasks','cacheableOperations','We\x20have\x20detected\x20another\x20agent\x20with\x20this\x20ID\x20running\x20in\x20this\x20workspace.\x20This\x20should\x20not\x20happen.','criticalErrorMessage','wait','error','env','filter','../../error/print-cacheable-targets-error','Other\x20Nx\x20Cloud\x20Agents\x20Detected','status:\x20','next','Waiting...','./distributed-agent.api','unlinkSync','targets','We\x20have\x20detected\x20other\x20agents\x20running\x20in\x20this\x20workspace.\x20This\x20can\x20cause\x20unexpected\x20behavior.','This\x20can\x20also\x20be\x20a\x20false\x20positive\x20caused\x20by\x20agents\x20that\x20did\x20not\x20shut\x20down\x20correctly.','.lock','../../../utilities/waiter','projectName','../../../utilities/nx-imports','NX_AGENT_NAME'];(function(_0x416217,_0x1aa3e9){const _0x365e13=function(_0x171e7a){while(--_0x171e7a){_0x416217['push'](_0x416217['shift']());}};_0x365e13(++_0x1aa3e9);}(a6_0x1aa3,0x176));const a6_0x365e=function(_0x416217,_0x1aa3e9){_0x416217=_0x416217-0x0;let _0x365e13=a6_0x1aa3[_0x416217];return _0x365e13;};'use strict';var __awaiter=this&&this[a6_0x365e('0xc')]||function(_0x23c3b0,_0x229aad,_0x31a380,_0x550722){function _0x9a692(_0x2db42b){return _0x2db42b instanceof _0x31a380?_0x2db42b:new _0x31a380(function(_0x346eee){_0x346eee(_0x2db42b);});}return new(_0x31a380||(_0x31a380=Promise))(function(_0x4d80b6,_0x536e3e){function _0x57d0c9(_0x1b4649){try{_0x3d12da(_0x550722['next'](_0x1b4649));}catch(_0x2d323b){_0x536e3e(_0x2d323b);}}function _0x2d2134(_0x333d12){try{_0x3d12da(_0x550722[a6_0x365e('0x3c')](_0x333d12));}catch(_0x16c77e){_0x536e3e(_0x16c77e);}}function _0x3d12da(_0xf33706){_0xf33706[a6_0x365e('0x2c')]?_0x4d80b6(_0xf33706[a6_0x365e('0x56')]):_0x9a692(_0xf33706[a6_0x365e('0x56')])[a6_0x365e('0x12')](_0x57d0c9,_0x2d2134);}_0x3d12da((_0x550722=_0x550722[a6_0x365e('0x31')](_0x23c3b0,_0x229aad||[]))[a6_0x365e('0x4a')]());});};Object[a6_0x365e('0x33')](exports,a6_0x365e('0x0'),{'value':!![]});exports['startAgent']=void 0x0;const child_process_1=require('child_process');const fs_1=require('fs');const stripJsonComments=require(a6_0x365e('0x5b'));const yargsParser=require('yargs-parser');const create_unchanged_value_timeout_1=require(a6_0x365e('0x6b'));const environment_1=require(a6_0x365e('0x70'));const metric_logger_1=require('../../../utilities/metric-logger');const waiter_1=require(a6_0x365e('0x52'));const print_cacheable_targets_error_1=require(a6_0x365e('0x47'));const print_invalid_runner_error_1=require(a6_0x365e('0x15'));const print_run_group_error_1=require(a6_0x365e('0x57'));const distributed_agent_api_1=require(a6_0x365e('0x4c'));const {output,workspaceRoot}=require(a6_0x365e('0x54'));const args=yargsParser(process[a6_0x365e('0x3d')],{'array':[a6_0x365e('0x4e')],'default':{}});if(args['targets']&&args[a6_0x365e('0x4e')][a6_0x365e('0x6c')]===0x1){args['targets']=args[a6_0x365e('0x4e')][0x0][a6_0x365e('0x13')](',')[a6_0x365e('0x68')](_0x3f29ef=>_0x3f29ef[a6_0x365e('0x21')]());}function executeTasks(_0x47bef3,_0x32b766){return __awaiter(this,void 0x0,void 0x0,function*(){let _0x345e83=0x0;let _0x45cd5e=null;const _0x4d1718=(0x0,create_unchanged_value_timeout_1['createUnchangedValueTimeout'])({'title':a6_0x365e('0x6a')+environment_1[a6_0x365e('0x59')]/0x3e8+'\x20seconds','timeout':environment_1[a6_0x365e('0x59')]});const _0x19172e=new waiter_1[(a6_0x365e('0x23'))]();let _0x6ad5e9=[];const _0x780762=new Date();let _0x1db747=![];while(!![]){if(environment_1['VERBOSE_LOGGING']){output[a6_0x365e('0x7')]({'title':a6_0x365e('0x5a')});}_0x45cd5e=yield _0x32b766['tasks'](_0x45cd5e?_0x45cd5e['executionId']:null,_0x345e83,_0x6ad5e9,args[a6_0x365e('0x4e')]);if(environment_1[a6_0x365e('0x64')]){output['note']({'title':a6_0x365e('0x9'),'bodyLines':['completed:\x20'+_0x45cd5e[a6_0x365e('0x58')],a6_0x365e('0x49')+_0x45cd5e[a6_0x365e('0x62')],a6_0x365e('0xd')+_0x45cd5e['retryDuring'],a6_0x365e('0x3a')+_0x45cd5e[a6_0x365e('0x65')],a6_0x365e('0x1')+_0x45cd5e[a6_0x365e('0x19')][a6_0x365e('0x6c')],a6_0x365e('0x38')+_0x45cd5e['criticalErrorMessage'],a6_0x365e('0x5d')+_0x45cd5e[a6_0x365e('0x30')]]});}if(_0x45cd5e[a6_0x365e('0x42')]){output[a6_0x365e('0x44')]({'title':'Distributed\x20Execution\x20Terminated','bodyLines':[a6_0x365e('0x5'),_0x45cd5e[a6_0x365e('0x42')]]});process[a6_0x365e('0x36')](0x0);}if((_0x45cd5e===null||_0x45cd5e===void 0x0?void 0x0:_0x45cd5e['retryDuring'])&&(_0x45cd5e===null||_0x45cd5e===void 0x0?void 0x0:_0x45cd5e[a6_0x365e('0x5c')])!==0x0&&!_0x1db747&&new Date()[a6_0x365e('0x1a')]()-_0x780762[a6_0x365e('0x1a')]()>_0x45cd5e[a6_0x365e('0x5c')]){yield _0x19172e[a6_0x365e('0x43')]();continue;}if((_0x45cd5e===null||_0x45cd5e===void 0x0?void 0x0:_0x45cd5e['status'])!==undefined){if(_0x45cd5e[a6_0x365e('0x62')]===a6_0x365e('0x66')||_0x45cd5e['status']===a6_0x365e('0x6d')){return;}}else if(_0x45cd5e['completed']){return;}_0x4d1718(_0x45cd5e['tasks'][a6_0x365e('0x68')](_0x4fd68f=>_0x4fd68f[a6_0x365e('0x25')])['join'](''));if(!_0x45cd5e['executionId']){if(environment_1[a6_0x365e('0x64')]){output[a6_0x365e('0x7')]({'title':a6_0x365e('0x4b')});}yield _0x19172e[a6_0x365e('0x43')]();_0x345e83=0x0;_0x6ad5e9=[];continue;}_0x19172e[a6_0x365e('0x67')]();_0x1db747=!![];const _0x2aff9c=invokeTasksUsingRunMany(_0x47bef3,_0x45cd5e[a6_0x365e('0x65')],_0x45cd5e[a6_0x365e('0x19')],_0x45cd5e[a6_0x365e('0x30')]);_0x345e83=_0x2aff9c['completedStatusCode'];_0x6ad5e9=_0x2aff9c[a6_0x365e('0x3f')];}});}function readCompletedTasks(_0x1aef13,_0x536691){const _0x220018=a6_0x365e('0x32')+_0x536691+a6_0x365e('0x35');let _0x16e65e;try{const _0x56dc41=(0x0,environment_1['getNxCacheDirectory'])(_0x1aef13);const _0x412d1d=_0x56dc41+'/tasks-hashes-'+_0x536691;_0x16e65e=JSON[a6_0x365e('0x29')]((0x0,fs_1[a6_0x365e('0x1b')])(_0x412d1d)[a6_0x365e('0x10')]());(0x0,fs_1[a6_0x365e('0x4d')])(_0x412d1d);}catch(_0xd228a9){throw new Error(_0x220018);}if(_0x16e65e[a6_0x365e('0x6c')]==0x0){throw new Error(_0x220018);}return _0x16e65e;}function invokeTasksUsingRunMany(_0x187aad,_0x58c44c,_0x54bdec,_0x1ccc5c){let _0x4975f8=0x0;const _0x1b6de5=[];for(const _0x5588d6 of groupByTarget(_0x54bdec)){const _0x2ff291=_0x5588d6[a6_0x365e('0x11')]?'--configuration='+_0x5588d6['configuration']:'';const _0x5328d5=_0x1ccc5c>0x1?'\x20--parallel\x20--max-parallel='+_0x1ccc5c:'';const _0x4fce29=a6_0x365e('0x18')+_0x5588d6[a6_0x365e('0x60')]+'\x20'+_0x2ff291+a6_0x365e('0x1f')+_0x5588d6['projects'][a6_0x365e('0x61')](',')+'\x20'+_0x5588d6[a6_0x365e('0xa')]+_0x5328d5;if(environment_1['VERBOSE_LOGGING']){output['note']({'title':'Executing:\x20\x27'+_0x4fce29+'\x27'});}try{(0x0,child_process_1[a6_0x365e('0x24')])(_0x4fce29,{'stdio':[a6_0x365e('0x28'),a6_0x365e('0x72'),a6_0x365e('0x72')],'env':Object[a6_0x365e('0x39')](Object[a6_0x365e('0x39')]({},process['env']),{'NX_CACHE_FAILURES':a6_0x365e('0x2d'),'NX_CLOUD_DISTRIBUTED_EXECUTION_ID':_0x58c44c,'NX_STREAM_OUTPUT':a6_0x365e('0x2d'),'NX_PREFIX_OUTPUT':a6_0x365e('0x2d')})});_0x1b6de5['push'](...readCompletedTasks(_0x187aad,_0x58c44c));}catch(_0x2b66d2){if(_0x2b66d2['status']===environment_1['DISTRIBUTED_TASK_EXECUTION_INTERNAL_ERROR_STATUS_CODE']){throw _0x2b66d2;}else{_0x4975f8=0x1;_0x1b6de5['push'](...readCompletedTasks(_0x187aad,_0x58c44c));}}}return{'completedStatusCode':_0x4975f8,'completedTasks':_0x1b6de5};}function groupByTarget(_0x3cb56a){const _0xda7bae=[];_0x3cb56a[a6_0x365e('0xe')](_0x3dc6ce=>{const _0x582691=_0xda7bae[a6_0x365e('0x63')](_0x539fc8=>_0x539fc8[a6_0x365e('0x60')]===_0x3dc6ce[a6_0x365e('0x60')]&&_0x539fc8[a6_0x365e('0x11')]===_0x3dc6ce[a6_0x365e('0x11')]);if(_0x582691){_0x582691['projects'][a6_0x365e('0x27')](_0x3dc6ce['projectName']);}else{_0xda7bae[a6_0x365e('0x27')]({'target':_0x3dc6ce['target'],'projects':[_0x3dc6ce[a6_0x365e('0x53')]],'params':_0x3dc6ce['params'],'configuration':_0x3dc6ce[a6_0x365e('0x11')]});}});return _0xda7bae;}function getAgentName(){if(process[a6_0x365e('0x45')][a6_0x365e('0x55')]!==undefined){return process['env'][a6_0x365e('0x55')];}else if(process[a6_0x365e('0x45')][a6_0x365e('0x22')]!==undefined&&process[a6_0x365e('0x45')][a6_0x365e('0x6f')]){return process['env']['CIRCLE_STAGE'];}else if(process[a6_0x365e('0x45')][a6_0x365e('0x22')]!==undefined&&process[a6_0x365e('0x45')]['CIRCLE_JOB']){return process['env'][a6_0x365e('0x69')];}else{return a6_0x365e('0x37')+Math[a6_0x365e('0x34')](Math['random']()*0x186a0);}}function createAgentLockfileAndSetUpListeners(_0x8f5b,_0x5adaa3,_0x451eba){const _0x5b29b9=(0x0,environment_1[a6_0x365e('0x1d')])(_0x5adaa3);const _0x51a3e4=_0x5b29b9+a6_0x365e('0x6e');const _0x4a6040=_0x51a3e4+'/'+_0x451eba+a6_0x365e('0x51');if(!(0x0,fs_1[a6_0x365e('0x3b')])(_0x51a3e4)){(0x0,fs_1[a6_0x365e('0xf')])(_0x51a3e4,{'recursive':!![]});}const _0x55ac89=(0x0,fs_1['readdirSync'])(_0x51a3e4);if(_0x55ac89[a6_0x365e('0x6c')]){if(_0x55ac89[a6_0x365e('0x5f')](_0x451eba+a6_0x365e('0x51'))){output[a6_0x365e('0x44')]({'title':a6_0x365e('0x2e'),'bodyLines':[a6_0x365e('0x41'),'',a6_0x365e('0x4')]});process['exit'](0x1);}output[a6_0x365e('0x17')]({'title':a6_0x365e('0x48'),'bodyLines':[a6_0x365e('0x4f'),'',a6_0x365e('0x50'),'If\x20you\x20believe\x20this\x20is\x20the\x20case,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22.']});}(0x0,fs_1[a6_0x365e('0x8')])(_0x4a6040,'');process['on']('exit',_0x19dc26=>{cleanupAgentLockfile(_0x4a6040,_0x19dc26);});process['on'](a6_0x365e('0x20'),()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x8f5b['completeRunGroupWithError']('Agent\x20was\x20terminated\x20via\x20SIGTERM');cleanupAgentLockfile(_0x4a6040,0x1);}));process['on'](a6_0x365e('0x3e'),()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x8f5b['completeRunGroupWithError']('Agent\x20was\x20terminated\x20via\x20SIGINT');cleanupAgentLockfile(_0x4a6040,0x1);}));}function cleanupAgentLockfile(_0x2ee76c,_0x157954){if((0x0,fs_1[a6_0x365e('0x3b')])(_0x2ee76c)){(0x0,fs_1[a6_0x365e('0x4d')])(_0x2ee76c);process[a6_0x365e('0x36')](_0x157954);}}function startAgent(){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x70d990=(0x0,environment_1[a6_0x365e('0x16')])();if(!_0x70d990){(0x0,print_run_group_error_1['printRunGroupError'])();return process[a6_0x365e('0x36')](0x1);}if(args[a6_0x365e('0x4e')]&&args[a6_0x365e('0x4e')][a6_0x365e('0x6c')]){output[a6_0x365e('0x7')]({'title':'Starting\x20an\x20agent\x20for\x20running\x20Nx\x20target(s)\x20['+args[a6_0x365e('0x4e')][a6_0x365e('0x61')](',\x20')+']'});}else{output['note']({'title':'Starting\x20an\x20agent\x20for\x20running\x20Nx\x20tasks'});}const _0x53fcbb=JSON[a6_0x365e('0x29')](stripJsonComments((0x0,fs_1[a6_0x365e('0x1b')])(workspaceRoot+'/nx.json')[a6_0x365e('0x10')]()))[a6_0x365e('0xb')]['default'];if(_0x53fcbb[a6_0x365e('0x26')]!==a6_0x365e('0x1c')){(0x0,print_invalid_runner_error_1[a6_0x365e('0x71')])();return process['exit'](0x1);}const _0x57e695=_0x53fcbb[a6_0x365e('0x2')];if(args['targets']&&args[a6_0x365e('0x4e')]['some'](_0x5f45c2=>{var _0x52e453;return!((_0x52e453=_0x57e695[a6_0x365e('0x40')])===null||_0x52e453===void 0x0?void 0x0:_0x52e453[a6_0x365e('0x5f')](_0x5f45c2));})){const _0x4939fc=args[a6_0x365e('0x4e')][a6_0x365e('0x46')](_0x2470de=>{var _0x26e400;return!((_0x26e400=_0x57e695[a6_0x365e('0x40')])===null||_0x26e400===void 0x0?void 0x0:_0x26e400['includes'](_0x2470de));});(0x0,print_cacheable_targets_error_1[a6_0x365e('0x5e')])(_0x4939fc);return process[a6_0x365e('0x36')](0x1);}const _0xad1e7d=getAgentName();const _0x4995b4=new distributed_agent_api_1[(a6_0x365e('0x2a'))](_0x57e695,_0x70d990,_0xad1e7d);createAgentLockfileAndSetUpListeners(_0x4995b4,_0x57e695,_0xad1e7d);return executeTasks(_0x57e695,_0x4995b4)[a6_0x365e('0x12')](_0x26a698=>__awaiter(this,void 0x0,void 0x0,function*(){yield(0x0,metric_logger_1[a6_0x365e('0x2b')])(_0x57e695);return _0x26a698;}))[a6_0x365e('0x2f')](_0x4e2d6e=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x4995b4[a6_0x365e('0x1e')](a6_0x365e('0x3')+_0x4e2d6e[a6_0x365e('0x6')]+'\x22');throw _0x4e2d6e;}));});}exports[a6_0x365e('0x14')]=startAgent;