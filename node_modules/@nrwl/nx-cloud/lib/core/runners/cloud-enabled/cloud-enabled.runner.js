const a1_0x3451=['/runs/','push','../../file-storage/file-storage','endsWith','path','message','localhost','length','getBranch','note','error','waitForStoreRequestsToComplete','extractGitSha','cachePath','printCacheHitsMessage','next','ErrorReporterApi','exit','./cloud-run.api','scan','throw','url','CloudRunApi','submitRunMetrics','toString','parseCommand','rxjs/internal/Subject','__esModule','done','daemon','assign','AGENT_RUNNING_IN_DISTRIBUTED_EXECUTION','endRun','.commit','join','getNxCacheDirectory','__awaiter','warn','uploads','FileStorage','toISOString','maskedProperties','env','ACCESS_TOKEN','then','writeFileSync','hash','../../api/error-reporter.api','all','.nx.app','apply','store','obfuscate','tasks-hashes-','pathExists','printMessages','startRun','Nx\x20Cloud\x20Problems','https://nx.app','taskId','stringify','../../terminal-output/end-of-run-message','MessageReporter','CloudEnabledLifeCycle','cloudEnabledTasksRunner','filter','requests','DISTRIBUTED_TASK_EXECUTION_INTERNAL_ERROR_STATUS_CODE','./id-generator','anyErrors','generateUniqueLinkId','map','subscribe','defineProperty','./cloud-enabled-life-cycle','../../terminal-output/message-reporter','NX_CLOUD_DISTRIBUTED_EXECUTION_ID','enabled','@nrwl/nx-cloud/lib/daemon/process-run-end','api.nrwl.io','local-cache-hit','complete','lifeCycle','CloudRemoteCache'];(function(_0x70de9a,_0x345120){const _0x2aa747=function(_0x2c224d){while(--_0x2c224d){_0x70de9a['push'](_0x70de9a['shift']());}};_0x2aa747(++_0x345120);}(a1_0x3451,0x81));const a1_0x2aa7=function(_0x70de9a,_0x345120){_0x70de9a=_0x70de9a-0x0;let _0x2aa747=a1_0x3451[_0x70de9a];return _0x2aa747;};'use strict';var __awaiter=this&&this[a1_0x2aa7('0x4b')]||function(_0x390636,_0x56dc0f,_0x25fa37,_0x4568bc){function _0x41607c(_0x1c334e){return _0x1c334e instanceof _0x25fa37?_0x1c334e:new _0x25fa37(function(_0x378249){_0x378249(_0x1c334e);});}return new(_0x25fa37||(_0x25fa37=Promise))(function(_0x115f83,_0x56fc2e){function _0x47206f(_0x1ea5a5){try{_0x3f0cae(_0x4568bc[a1_0x2aa7('0x36')](_0x1ea5a5));}catch(_0x36930a){_0x56fc2e(_0x36930a);}}function _0x14ee94(_0x434aa4){try{_0x3f0cae(_0x4568bc[a1_0x2aa7('0x3b')](_0x434aa4));}catch(_0x1f134c){_0x56fc2e(_0x1f134c);}}function _0x3f0cae(_0x10738c){_0x10738c[a1_0x2aa7('0x43')]?_0x115f83(_0x10738c['value']):_0x41607c(_0x10738c['value'])[a1_0x2aa7('0x53')](_0x47206f,_0x14ee94);}_0x3f0cae((_0x4568bc=_0x4568bc[a1_0x2aa7('0x5')](_0x390636,_0x56dc0f||[]))[a1_0x2aa7('0x36')]());});};Object[a1_0x2aa7('0x1c')](exports,a1_0x2aa7('0x42'),{'value':!![]});exports[a1_0x2aa7('0x13')]=void 0x0;const message_reporter_1=require(a1_0x2aa7('0x1e'));const end_of_run_message_1=require(a1_0x2aa7('0x10'));const output_obfuscator_1=require('../../terminal-output/output-obfuscator');const cloud_enabled_life_cycle_1=require(a1_0x2aa7('0x1d'));const file_storage_1=require(a1_0x2aa7('0x29'));const e2e_encryption_1=require('../../file-storage/e2e-encryption');const environment_1=require('../../../utilities/environment');const cloud_remote_cache_1=require('./cloud-remote-cache');const cloud_run_api_1=require(a1_0x2aa7('0x39'));const fs_1=require('fs');const path=require(a1_0x2aa7('0x2b'));const metric_logger_1=require('../../../utilities/metric-logger');const error_reporter_api_1=require(a1_0x2aa7('0x2'));const path_1=require(a1_0x2aa7('0x2b'));const fs_extra_1=require('fs-extra');const id_generator_1=require(a1_0x2aa7('0x17'));const {tasksRunner,output,Cache}=require('../../../utilities/nx-imports');function createApi(_0x5b2876,_0x232927,_0xb4caf){const _0x3009d7=(0x0,environment_1['getMachineInfo'])(_0x232927);return new cloud_run_api_1[(a1_0x2aa7('0x3d'))](_0x5b2876,_0xb4caf,_0x232927,_0x3009d7);}function storeTaskHashes(_0x13346e,_0x4c4cf7,_0x5abdf0){const _0x238eb6=JSON[a1_0x2aa7('0xf')](_0x13346e[a1_0x2aa7('0x1a')](_0x1d1320=>({'taskId':_0x1d1320[a1_0x2aa7('0xe')],'hash':_0x1d1320['hash']})));if(environment_1['VERBOSE_LOGGING']){output[a1_0x2aa7('0x30')]({'title':'Executed\x20tasks\x20with\x20hashes:\x20'+_0x238eb6});}(0x0,fs_1[a1_0x2aa7('0x0')])(path[a1_0x2aa7('0x49')](_0x4c4cf7,a1_0x2aa7('0x8')+_0x5abdf0),_0x238eb6);}function storeLocalCacheHits(_0x25e4aa,_0x5ccd67,_0x2c37e1){const _0x203ace=_0x25e4aa[a1_0x2aa7('0x14')](_0x517204=>_0x517204['cacheStatus']===a1_0x2aa7('0x23'))['map'](_0x17c4ac=>_0x17c4ac[a1_0x2aa7('0x1')]);_0x203ace['forEach'](_0x5c6de9=>_0x5ccd67[a1_0x2aa7('0x6')](_0x5c6de9,_0x2c37e1));}function onComplete({daemon,lifeCycle,options,remoteCache,api,outputObfuscator,runStartTime,messages,endOfRunMessage,taskExecutions,versionOfNxBefore133,inner,encryptionKey,fileStorage,uploadInCurrentProcess,runContext}){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x59a419=new Date()[a1_0x2aa7('0x4f')]();const _0x2a801c=(0x0,environment_1[a1_0x2aa7('0x2f')])();const _0x7fab1a={'command':outputObfuscator[a1_0x2aa7('0x7')]((0x0,environment_1[a1_0x2aa7('0x40')])()),'startTime':runStartTime,'endTime':_0x59a419,'distributedExecutionId':environment_1[a1_0x2aa7('0x1f')],'branch':_0x2a801c,'scan':!![],'runGroup':(0x0,environment_1['getRunGroup'])(),'sha':_0x2a801c?(0x0,environment_1[a1_0x2aa7('0x33')])():undefined,'inner':inner};if(uploadInCurrentProcess){if(environment_1[a1_0x2aa7('0x46')]){const _0x2e2a41=(0x0,environment_1[a1_0x2aa7('0x4a')])(options);storeTaskHashes(taskExecutions,_0x2e2a41,environment_1[a1_0x2aa7('0x1f')]);storeLocalCacheHits(taskExecutions,remoteCache,_0x2e2a41);}try{yield remoteCache[a1_0x2aa7('0x32')]();}catch(_0x2466e3){output[a1_0x2aa7('0x31')]({'title':'Nx\x20Cloud\x20wasn\x27t\x20able\x20to\x20store\x20artifacts.'});messages['printMessages']();process[a1_0x2aa7('0x38')](environment_1[a1_0x2aa7('0x16')]);}try{yield api[a1_0x2aa7('0x47')](_0x7fab1a,taskExecutions);}catch(_0x2f768e){output[a1_0x2aa7('0x31')]({'title':'Nx\x20Cloud\x20wasn\x27t\x20able\x20to\x20record\x20its\x20run.'});messages['printMessages']();process[a1_0x2aa7('0x38')](environment_1['DISTRIBUTED_TASK_EXECUTION_INTERNAL_ERROR_STATUS_CODE']);}yield(0x0,metric_logger_1[a1_0x2aa7('0x3e')])(options);}else{try{const _0x301310=environment_1['ACCESS_TOKEN']?environment_1[a1_0x2aa7('0x52')]:options['accessToken'];const _0x5c5561=(0x0,id_generator_1[a1_0x2aa7('0x19')])();yield daemon['processInBackground'](a1_0x2aa7('0x21'),{'encryptionKey':encryptionKey,'runnerOptions':Object[a1_0x2aa7('0x45')](Object[a1_0x2aa7('0x45')]({},options),{'accessToken':_0x301310}),'uploads':fileStorage[a1_0x2aa7('0x4d')],'runEnd':{'runData':_0x7fab1a,'taskExecutions':taskExecutions,'linkId':_0x5c5561}});runContext['runUrl']=(options['url']||a1_0x2aa7('0xd'))+a1_0x2aa7('0x27')+_0x5c5561;}catch(_0x971a06){output[a1_0x2aa7('0x4c')]({'title':a1_0x2aa7('0xc'),'bodyLines':[_0x971a06[a1_0x2aa7('0x2c')]||_0x971a06[a1_0x2aa7('0x3f')]()]});}}if(versionOfNxBefore133){setTimeout(()=>{messages[a1_0x2aa7('0xa')]();if(!messages[a1_0x2aa7('0x18')]&&!inner){endOfRunMessage[a1_0x2aa7('0x35')]();}},0x0);}else{messages[a1_0x2aa7('0xa')]();if(!messages[a1_0x2aa7('0x18')]&&!inner){endOfRunMessage[a1_0x2aa7('0x35')]();}}});}function createLifeCycle(_0x292daf,_0x4fd543,_0x1c7ee2,_0x27c7b1){const _0x7e12e4=new cloud_enabled_life_cycle_1[(a1_0x2aa7('0x12'))](_0x292daf,(0x0,environment_1[a1_0x2aa7('0x4a')])(_0x4fd543),_0x4fd543['scan']===undefined?!![]:_0x4fd543[a1_0x2aa7('0x3a')],_0x4fd543['cacheableOperations']||[],_0x1c7ee2,_0x27c7b1);try{const {CompositeLifeCycle}=require('../../../utilities/nx-imports');if(!CompositeLifeCycle)return _0x7e12e4;return new CompositeLifeCycle([_0x4fd543[a1_0x2aa7('0x25')],_0x7e12e4]);}catch(_0x2ea9b1){return _0x7e12e4;}}function fetchUrlsForKnownHashesUpfront(_0x52ab2a,_0x8dbc3e,_0x324cd0,_0x1d54c3){return __awaiter(this,void 0x0,void 0x0,function*(){let _0x211852=_0x324cd0[a1_0x2aa7('0x1a')](_0x2c96d4=>_0x2c96d4['hash'])[a1_0x2aa7('0x14')](_0x3334d3=>!!_0x3334d3);const _0x4f2aca=new Cache(_0x1d54c3);if(!_0x1d54c3['skipNxCache']){const _0xe50b21=yield Promise[a1_0x2aa7('0x3')](_0x211852['map'](_0x402d15=>{const _0x580acc=(0x0,path_1[a1_0x2aa7('0x49')])(_0x4f2aca[a1_0x2aa7('0x34')],_0x402d15+a1_0x2aa7('0x48'));return(0x0,fs_extra_1[a1_0x2aa7('0x9')])(_0x580acc);}));const _0x5b32e1=[];for(let _0x23d46e=0x0;_0x23d46e<_0xe50b21['length'];++_0x23d46e){if(_0xe50b21[_0x23d46e]){_0x5b32e1[a1_0x2aa7('0x28')](_0x211852[_0x23d46e]);}}_0x211852=_0x5b32e1;}if(_0x211852[a1_0x2aa7('0x2e')]>0x0){const _0x28c758=_0x52ab2a[a1_0x2aa7('0xb')](environment_1['NX_CLOUD_DISTRIBUTED_EXECUTION_ID'],_0x211852);for(const _0x5b58d9 of _0x211852){_0x8dbc3e[a1_0x2aa7('0x15')][_0x5b58d9]=_0x28c758;}}});}function isConnectedToPrivateCloud(_0x531957){if(!_0x531957[a1_0x2aa7('0x3c')])return![];if(_0x531957[a1_0x2aa7('0x3c')][a1_0x2aa7('0x2a')](a1_0x2aa7('0x22')))return![];if(_0x531957[a1_0x2aa7('0x3c')][a1_0x2aa7('0x2a')](a1_0x2aa7('0x4')))return![];if(_0x531957[a1_0x2aa7('0x3c')]['indexOf'](a1_0x2aa7('0x2d'))>-0x1)return![];return!![];}function cloudEnabledTasksRunner(_0x3d0abf,_0x10b72b,_0x1da777,_0x208af6=![]){var _0xe0953c;const _0xb6f91b={'statuses':{},'scheduledTasks':[],'requests':{},'allTasks':_0x3d0abf};const _0x2e2923=_0x10b72b[a1_0x2aa7('0x25')]===undefined;const _0x4dcd0c=[];const _0x1b2227=new message_reporter_1[(a1_0x2aa7('0x11'))](_0x10b72b);const _0x438c0b=createApi(_0x1b2227,_0x10b72b,_0xb6f91b);const _0x47f5ba=new end_of_run_message_1['EndOfRunMessage'](_0xb6f91b,_0x4dcd0c);const _0x1f2220=new output_obfuscator_1['OutputObfuscator'](_0x10b72b[a1_0x2aa7('0x50')]);const _0x28a632=new Date()['toISOString']();const _0x367f30=createLifeCycle(_0xb6f91b,_0x10b72b,_0x1f2220,_0x4dcd0c);const _0x35c224=environment_1['ENCRYPTION_KEY']||_0x10b72b['encryptionKey'];const _0x2e617a=new e2e_encryption_1['E2EEncryption'](_0x35c224);const _0x420d77=new error_reporter_api_1[(a1_0x2aa7('0x37'))](_0x10b72b);const _0x59ab50=!!environment_1[a1_0x2aa7('0x46')]||!((_0xe0953c=_0x1da777[a1_0x2aa7('0x44')])===null||_0xe0953c===void 0x0?void 0x0:_0xe0953c[a1_0x2aa7('0x20')]())||isConnectedToPrivateCloud(_0x10b72b);const _0x23143c=new file_storage_1[(a1_0x2aa7('0x4e'))](_0x2e617a,_0x420d77,![],_0x59ab50);const _0x36263d=new cloud_remote_cache_1[(a1_0x2aa7('0x26'))](_0x1b2227,_0x438c0b,_0xb6f91b,_0x23143c);fetchUrlsForKnownHashesUpfront(_0x438c0b,_0xb6f91b,_0x3d0abf,_0x10b72b);delete process[a1_0x2aa7('0x51')][a1_0x2aa7('0x1f')];const _0x523ba0=tasksRunner(_0x3d0abf,Object['assign'](Object['assign']({},_0x10b72b),{'remoteCache':_0x36263d,'lifeCycle':_0x367f30}),_0x1da777);if(_0x523ba0[a1_0x2aa7('0x1b')]){const {Subject}=require(a1_0x2aa7('0x41'));const _0x206b96=new Subject();_0x523ba0[a1_0x2aa7('0x1b')]({'next':_0x4470fe=>_0x206b96[a1_0x2aa7('0x36')](_0x4470fe),'error':_0x4ef586=>_0x206b96[a1_0x2aa7('0x31')](_0x4ef586),'complete':()=>__awaiter(this,void 0x0,void 0x0,function*(){yield onComplete({'daemon':_0x1da777[a1_0x2aa7('0x44')],'lifeCycle':_0x367f30,'options':_0x10b72b,'remoteCache':_0x36263d,'api':_0x438c0b,'outputObfuscator':_0x1f2220,'runStartTime':_0x28a632,'messages':_0x1b2227,'endOfRunMessage':_0x47f5ba,'taskExecutions':_0x4dcd0c,'versionOfNxBefore133':_0x2e2923,'inner':_0x208af6,'encryptionKey':_0x35c224,'fileStorage':_0x23143c,'uploadInCurrentProcess':_0x59ab50,'runContext':_0xb6f91b});_0x206b96[a1_0x2aa7('0x24')]();})});return _0x206b96;}else{return _0x523ba0[a1_0x2aa7('0x53')](_0x562a79=>__awaiter(this,void 0x0,void 0x0,function*(){yield onComplete({'daemon':_0x1da777['daemon'],'lifeCycle':_0x367f30,'options':_0x10b72b,'remoteCache':_0x36263d,'api':_0x438c0b,'outputObfuscator':_0x1f2220,'runStartTime':_0x28a632,'messages':_0x1b2227,'endOfRunMessage':_0x47f5ba,'taskExecutions':_0x4dcd0c,'versionOfNxBefore133':_0x2e2923,'inner':_0x208af6,'encryptionKey':_0x35c224,'fileStorage':_0x23143c,'uploadInCurrentProcess':_0x59ab50,'runContext':_0xb6f91b});return _0x562a79;}))['catch'](_0x221646=>__awaiter(this,void 0x0,void 0x0,function*(){yield onComplete({'daemon':_0x1da777[a1_0x2aa7('0x44')],'lifeCycle':_0x367f30,'options':_0x10b72b,'remoteCache':_0x36263d,'api':_0x438c0b,'outputObfuscator':_0x1f2220,'runStartTime':_0x28a632,'messages':_0x1b2227,'endOfRunMessage':_0x47f5ba,'taskExecutions':_0x4dcd0c,'versionOfNxBefore133':_0x2e2923,'inner':_0x208af6,'encryptionKey':_0x35c224,'fileStorage':_0x23143c,'uploadInCurrentProcess':_0x59ab50,'runContext':_0xb6f91b});throw _0x221646;}));}}exports[a1_0x2aa7('0x13')]=cloudEnabledTasksRunner;